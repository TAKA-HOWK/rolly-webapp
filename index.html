<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Заказ рольштор</title>
<style>
  :root {--bg:#0f1115;--card:#171a21;--muted:#8a94a7;--text:#e7ecf3;--accent:#4aa3ff;--danger:#ff6b6b;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif; overscroll-behavior-x: none;}
  .wrap{max-width:720px;margin:auto;padding:16px}
  .card{background:var(--card);border:1px solid #232634;border-radius:14px;padding:14px}
  h1{margin:8px 0 14px;font-size:20px}
  .grid{display:grid;gap:10px}
  .row{display:flex;gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:12px;border:1px solid #2a2f3d;background:#10131a;color:var(--text)}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #2a2f3d;cursor:pointer;display:inline-block}
  .pill.active{border-color:#315aee}
  .pillr{padding:8px 12px;border-radius:999px;border:1px solid #2a2f3d;cursor:pointer;display:inline-block}
  .pillr.active{border-color:#315aee}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#2a7ee8);color:#fff}
  .btn.secondary{background:#121620;color:var(--text);border:1px solid #2a2f3d}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling: touch;margin-top:14px}
  table{width:100%;min-width:640px;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #232634;font-size:14px}
  thead th{background:#111520;color:#cfe2ff;font-size:12px}
  .tag{color:#b9f4ce;font-size:12px}
  .right{text-align:right}
  .del{border:none;background:transparent;color:var(--danger);cursor:pointer}
  .dropdown {position: relative;display: inline-block;width: 250px;z-index: 1000;}
  .dropdown-toggle {padding: 10px;background: #2a2f3d;color: #fff;cursor: pointer;border-radius: 8px;}
  .dropdown-menu {display: none;position: absolute;background: #171a21;border: 1px solid #333;width: 100%;max-height: 300px;overflow-y: auto;border-radius: 8px;z-index: 10;}
  .group-label {padding: 10px;cursor: pointer;background: #1e232c;font-weight: bold;color: #4aa3ff;}
  .group-options {display: none;}
  .group-options div {padding: 8px 14px;cursor: pointer;color: #e7ecf3;}
  .group-options div:hover {background: #2a2f3d;}
  .edit, .del {font-size: 18px;padding: 6px 10px;border: none;background: transparent;cursor: pointer;}
  
  @media (max-width: 600px) {
    h1 {font-size: 18px;text-align: center;}
    .grid, .row {display: block;}
    input, select, textarea {font-size: 16px;padding: 12px;border-radius: 10px;}
    label {font-size: 13px;margin-bottom: 4px;}
    .btns {flex-direction: column;align-items: stretch;}
    .btn {width: 70%;padding: 14px;font-size: 16px;}
    .pill, .pillr {display: inline-block;margin-bottom: 6px;}
    .dropdown {width: 70%;}
    .dropdown-toggle {padding: 12px;font-size: 16px;}
    .dropdown-menu {max-height: 220px;font-size: 15px;}
    .table-wrap {overflow-x: auto;}
    table {font-size: 13px;}
    th, td {padding: 8px 6px;white-space: nowrap;}
    .edit, .del {font-size: 16px;padding: 4px;}
    #orderInfo div {font-size: 14px;}
    #sortSelect {font-size: 14px;padding: 8px;margin-top: 14px;}
    #notes {font-size: 14px;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Заказ рольштор</h1>
    <div class="grid">
      <div><label>Дата заказа:</label><input id="date" type="date" title="Укажите дату оформления заказа"></div>
      <div><label>Номер заказа:</label><input id="numb" type="number" title="Введите номер для отслеживания"></div>
      <div><label>Заказчик:</label><input id="customer" type="text" placeholder="ИП 'Успешный'" title="Укажите имя или компанию заказчика"></div>
      <input type="hidden" name="system" id="systemInput" value="">
      <div class="dropdown" id="systemDropdown">
        <div class="dropdown-toggle">Выберите систему</div> <br>
        <div class="dropdown-menu">
          <!-- Здесь список систем, как в твоем коде -->
        </div>
      </div>
      <div><label>Цвет ткани:</label><input id="color" type="text" pattern="[0-9\-]+" maxlength="6" placeholder="721-01" title="Код ткани (например, 721-01)"></div>
      <div class="row">
        <div><label>Ширина, см:</label><input id="width" type="number" min="0.1" step="0.1" title="Укажите ширину изделия в сантиметрах"></div>
        <div><label>Высота, см:</label><input id="height" type="number" min="0.1" step="0.1" title="Укажите высоту изделия в сантиметрах"></div>
      </div>
      <div><label>По чем размеры</label>
        <div id="basis" title="Выберите, по каким параметрам заданы размеры">
          <span class="pillr" data-val="ВГШ" title="Внешний габарит штапика">ВГШ</span>
          <span class="pillr" data-val="по Ткани" title="Размеры только по ткани">по Ткани</span>
          <span class="pillr" data-val="по Габаритам" title="Полный габарит изделия">по Габаритам</span>
        </div>   
      </div>
      <div><label>Сторона управления:</label>
        <div id="sideGroup" title="Выберите сторону расположения управления">
          <span class="pill" data-val="слева" title="Механизм управления слева">Слева</span>
          <span class="pill" data-val="справа" title="Механизм управления справа">Справа</span>
        </div>
      </div>
      <div><label>Количество изделий:</label><input id="qty" type="number" min="1" step="1" title="Сколько одинаковых изделий добавить"></div>
      <div style="align-self:end"><button class="btn primary" id="addBtn" title="Добавить изделие в таблицу ниже">Добавить в заказ</button></div>
    </div>

    <div id="orderInfo" style="margin-top:20px;margin-bottom:10px;display:none;">
       <div><strong>Дата заказа:</strong> <span id="dateNumberDisplay"></span></div>
      <div><strong>Номер заказа:</strong> <span id="orderNumberDisplay"></span></div>
      <div><strong>Заказчик:</strong> <span id="customerDisplay"></span></div>
    </div>

    <div class="table-wrap">
      <table id="ordersTable">
        <thead><tr><th>#</th><th>Система</th><th>Цвет</th><th>Ширина(См)</th><th>Высота(См)</th><th>Размеры</th><th>Управление</th><th>Кол-во</th><th></th></tr></thead>
        <tbody id="tbody"><tr><td colspan="8" style="color:#8a94a7">Нет позиций</td></tr></tbody>
      </table>
    </div>

    <div style="margin-top:16px;">
      <label for="notes" style="color:var(--muted);font-size:13px;">Примечание:</label>
      <textarea id="notes" rows="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a2f3d;background:#10131a;color:#e7ecf3;"></textarea>
    </div>

    <div class="btns">
      <button class="btn primary" id="saveJpeg" title="Сохранить заказ как изображение (JPEG)">Сохранить JPEG</button>
      <button class="btn secondary" id="clearBtn" title="Очистить таблицу и форму">Очистить</button> 
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
let rows=[];

// --- твой код для добавления/удаления/редактирования строк и выпадающего списка ---
/* ... оставляем весь код, который был у тебя, кроме функции $("#saveJpeg").onclick ... */

// --- Новая версия JPEG для мобильного Telegram ---
$("#saveJpeg").onclick = () => {
  if (!rows.length) { alert("Таблица пуста"); return; }

  const pageWidth = 842;
  const pageHeight = 595;
  const margin = 40;
  const dpi = 2;
  const contentWidth = pageWidth - margin*2;

  const dateNumber = $("#date").value.trim();
  const orderNumber = $("#numb").value.trim();
  const customer = $("#customer").value.trim();
  const notes = $("#notes").value.trim();

  const headers = ["#", "Система", "Цвет", "Ширина", "Высота", "Размеры", "Управление", "Кол-во","Примечание"];
  const colW = [40, 100, 100, 70, 70, 85, 85, 60, 153];

  const rowH = 28;
  const headH = 36;
  const orderInfoH = 60;

  const availableHeight = pageHeight - margin*2 - orderInfoH - headH;
  const maxRows = Math.floor(availableHeight/rowH);
  const totalPages = Math.ceil(rows.length/maxRows);

  for (let page=0; page<totalPages; page++){
    const canvas = document.createElement("canvas");
    canvas.width = pageWidth*dpi;
    canvas.height = pageHeight*dpi;

    const ctx = canvas.getContext("2d");
    ctx.scale(dpi,dpi);

    // Белый фон
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,pageWidth,pageHeight);

    let xStart = margin;
    let yStart = margin;

    // Заголовки
    ctx.fillStyle = "#000";
    ctx.font = "bold 16px Arial";
    ctx.textBaseline = "top";
    ctx.fillText(`Дата заказа: ${dateNumber||"-"}`, xStart, yStart);
    ctx.fillText(`Номер заказа: ${orderNumber||"-"}`, xStart+210, yStart);
    ctx.fillText(`Заказчик: ${customer||"-"}`, xStart+420, yStart);

    // Заголовки таблицы
    yStart += orderInfoH;
    ctx.fillStyle = "#ddd";
    ctx.fillRect(xStart,yStart,contentWidth,headH);

    let colX = xStart;
    headers.forEach((header,i)=>{
      ctx.fillStyle="#000";
      ctx.font="bold 13px Arial";
      ctx.fillText(header, colX+6, yStart+10);
      ctx.strokeStyle="#999";
      ctx.strokeRect(colX, yStart, colW[i], headH);
      colX += colW[i];
    });

    // Строки
    const startRow = page*maxRows;
    const endRow = Math.min(startRow+maxRows, rows.length);
    const currentRows = rows.slice(startRow,endRow);

    currentRows.forEach((r,i)=>{
      const y = yStart + headH + i*rowH;
      const row = [startRow+i+1, r.system, r.color, r.width, r.height, r.basis, r.side, r.qty, notes||""];
      let xx = xStart;

      ctx.fillStyle = i%2 ? "#f8f8f8" : "#fff";
      ctx.fillRect(xStart, y, contentWidth, rowH);

      row.forEach((cell,ci)=>{
        ctx.strokeStyle="#ccc";
        ctx.strokeRect(xx, y, colW[ci], rowH);
        ctx.fillStyle="#000";
        ctx.font="13px Arial";
        ctx.fillText(cell, xx+6, y+8);
        xx += colW[ci];
      });
    });

    // Номер страницы
    ctx.fillStyle="#999";
    ctx.font="12px Arial";
    ctx.fillText(`Страница ${page+1} из ${totalPages}`, pageWidth-margin-120, pageHeight-margin+5);

    // Открываем в новой вкладке для сохранения на мобильном
    const imageUrl = canvas.toDataURL("image/jpeg", 0.95);
    window.open(imageUrl,"_blank");
  }
};
</script>
</body>
</html>
