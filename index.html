<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Заказ рольштор</title>
<script>
  // Грузим Telegram SDK неблокирующе: если не загрузится, страница всё равно откроется.
  (function loadTelegramSdk() {
    const s = document.createElement("script");
    s.src = "https://telegram.org/js/telegram-web-app.js";
    s.async = true;
    s.defer = true;
    document.head.appendChild(s);
  })();
</script>
<style>
  :root {--bg:#0f1115;--card:#171a21;--muted:#8a94a7;--text:#e7ecf3;--accent:#4aa3ff;--danger:#ff6b6b;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif; overscroll-behavior-x: none;}
  .wrap{max-width:720px;margin:auto;padding:16px}
  .card{background:var(--card);border:1px solid #232634;border-radius:14px;padding:14px}
  h1{margin:8px 0 14px;font-size:20px}
  .grid{display:grid;gap:10px}
  .row{display:flex;gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:12px;border:1px solid #2a2f3d;background:#10131a;color:var(--text)}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #2a2f3d;cursor:pointer;display:inline-block}
  .pill.active{border-color:#315aee}
  .pillr{padding:8px 12px;border-radius:999px;border:1px solid #2a2f3d;cursor:pointer;display:inline-block}
  .pillr.active{border-color:#315aee}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#2a7ee8);color:#fff}
  .btn.secondary{background:#121620;color:var(--text);border:1px solid #2a2f3d}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling: touch;margin-top:14px}
  table{width:100%;min-width:640px;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #232634;font-size:14px}
  thead th{background:#111520;color:#cfe2ff;font-size:12px}
  .tag{color:#b9f4ce;font-size:12px}
  .right{text-align:right}
  .del{border:none;background:transparent;color:var(--danger);cursor:pointer}
  .dropdown {position: relative;display: inline-block;width: 250px;z-index: 1000;}
@@ -388,52 +398,82 @@ $("#clearBtn").onclick = () => {
    $("#color").value = "";
    $("#width").value = "";
    $("#height").value = "";
    $("#qty").value = "";
    $("#notes").value = "";

    // Сброс выпадающего списка "система"
    const toggle = $(".dropdown-toggle");
    toggle.textContent = "Выберите систему";
    delete toggle.dataset.value;

    // Сброс активных плашек
    $$("#basis .pillr").forEach(el => el.classList.remove("active"));
    $$("#sideGroup .pill").forEach(el => el.classList.remove("active"));

    // Скрыть отображение информации о заказе
    $("#orderInfo").style.display = "none";
    $("#dateNumberDisplay").textContent = "";
    $("#orderNumberDisplay").textContent = "";
    $("#customerDisplay").textContent = "";
  }
};

    
    
function buildOrderPayload() {
  return {
    type: "order",
    date: $("#date").value.trim(),
    orderNumber: $("#numb").value.trim(),
    customer: $("#customer").value.trim(),
    notes: $("#notes").value.trim(),
    rows,
  };
}

function sendOrderToTelegram() {
  const tg = window.Telegram?.WebApp;
  if (!tg) {
    alert("Ошибка: откройте WebApp через Telegram");
    return false;
  }

  const payload = JSON.stringify(buildOrderPayload());

  // Telegram WebApp.sendData имеет лимит в 4096 символов.
  if (payload.length > 4000) {
    alert("Заказ слишком большой для отправки через Telegram. Уменьшите количество строк или примечание.");
    return false;
  }

  tg.sendData(payload);
  return true;
}

// --- JPEG экспорт с разбивкой на страницы A4 + отправка данных в Telegram ---
$("#saveJpeg").onclick = () => {
  if (!rows.length) {
    alert("Таблица пуста");
    return;
  }

  // A4 landscape: 842 x 595 при 96 DPI
  const pageWidth = 842;
  const pageHeight = 595;
  const margin = 40;
  const dpi = 2;

  const contentWidth = pageWidth - margin * 2;

  // Данные формы
  const dateNumber = $("#date").value.trim();
  const orderNumber = $("#numb").value.trim();
  const customer = $("#customer").value.trim();
  const notes = $("#notes").value.trim();

  const headers = ["#", "Система", "Цвет", "Ширина", "Высота", "Размеры", "Управление", "Кол-во","Для заметок"];
  const colW = [40, 100, 100, 70, 70, 85, 85, 60,153]; // сумма = 610 + 153

  const rowH = 28;
  const headH = 36;
  const orderInfoH = 60;
@@ -502,87 +542,95 @@ $("#saveJpeg").onclick = () => {
        ctx.font = "13px Arial";
        ctx.fillText(cell, xx + 6, y + 8);
        xx += colW[ci];
      });
    });

    // --- Примечание — только на последней странице ---
    if (page === totalPages - 1 && notes) {
      const yNotes = yStart + headH + currentRows.length * rowH + 10;
      ctx.fillStyle = "#444";
      ctx.font = "italic 13px Arial";
      ctx.fillText("Примечание:", xStart, yNotes);

      ctx.fillStyle = "#222";
      ctx.font = "13px Arial";
      notes.split('\n').forEach((line, i) => {
        ctx.fillText(line, xStart, yNotes + 20 + i * 16, contentWidth - 10);
      });
    }

    // --- Номер страницы ---
    ctx.fillStyle = "#999";
    ctx.font = "12px Arial";
    ctx.fillText(`Страница ${page + 1} из ${totalPages}`, pageWidth - margin - 120, pageHeight - margin + 5);

	// --- Сохранить как JPEG локально ---
    const imgData = canvas.toDataURL("image/jpeg", 0.95);
    const link = document.createElement("a");
    link.href = imgData;
    link.download = `order_${orderNumber || "no_number"}_p${page + 1}.jpg`;
    link.click();
	}

  sendOrderToTelegram();
};




render();

if (window.Telegram?.WebApp) {
  window.Telegram.WebApp.ready();
  window.Telegram.WebApp.expand();
}
  
  //выпадающий список с выбором систем
  
const dropdown = document.getElementById('systemDropdown');
if (dropdown) {
const toggle = dropdown.querySelector('.dropdown-toggle');
const menu = dropdown.querySelector('.dropdown-menu');
const labels = dropdown.querySelectorAll('.group-label');
const options = dropdown.querySelectorAll('.group-options div');

// открыть/закрыть выпадашку
toggle.onclick = () => {
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
};

// по клику на группу — открыть/закрыть вложенные опции
labels.forEach(label => {
  label.onclick = () => {
    const options = label.nextElementSibling;
    const isOpen = options.style.display === 'block';
    dropdown.querySelectorAll('.group-options').forEach(o => o.style.display = 'none');
    options.style.display = isOpen ? 'none' : 'block';
  };
});

// выбор значения
options.forEach(opt => {
  opt.onclick = () => {
    toggle.textContent = opt.textContent;
    toggle.dataset.value = opt.dataset.value;
    menu.style.display = 'none';
  // Подставляем в форму
      const systemInput = document.getElementById('systemInput');
      if (systemInput) systemInput.value = opt.dataset.value;
  };
});

// клик вне — закрыть
document.addEventListener('click', e => {
  if (!dropdown.contains(e.target)) {
    menu.style.display = 'none';
    dropdown.querySelectorAll('.group-options').forEach(o => o.style.display = 'none');
  }
}); 
}
  
</script>
</body>
</html>
